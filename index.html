<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --red: #ff0000; --bg: #f4f4f4; --yellow: #ffc107; --blue: #0d6efd; --gray: #6c757d; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; direction: rtl; }
header { background: #fff; padding: 12px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
.btn { background: var(--red); color: #fff; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; font-weight: bold; }
.container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
.upload-card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none; }
input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; }
.video-item { background: #fff; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }
video { width: 100%; aspect-ratio: 16/9; background: #000; display: block; }
.p-15 { padding: 15px; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
.modal-box { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 380px; text-align: center; }
.video-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    padding: 0 15px 15px;
    color: #666;
    font-size: 0.9rem;
}
.stat-btn {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border-radius: 15px;
    transition: all 0.2s;
}
.stat-btn:hover {
    background: #f5f5f5;
}
.stat-btn.liked {
    color: var(--yellow);
}
.stat-btn.comments-active {
    background: #e3f2fd;
    color: var(--blue);
}
.stats-container {
    display: flex;
    gap: 15px;
}
.authenticated-only { display: none; }
.user-authenticated .authenticated-only { display: inline-block; }
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.error-message {
    color: red;
    text-align: center;
    padding: 20px;
    border: 1px solid #ffdddd;
    border-radius: 8px;
    background: #fff9f9;
    margin: 10px;
}
.comments-section {
    padding: 0 15px 15px;
    border-top: 1px solid #eee;
    display: none;
}
.comment-input-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}
.comment-input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 20px;
    resize: none;
    direction: rtl;
}
.comment-btn {
    background: var(--blue);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
}
.comments-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.comment-item {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 12px;
    border-left: 3px solid var(--blue);
}
.comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}
.comment-content {
    line-height: 1.5;
    color: #555;
}
.comment-time {
    font-size: 0.8rem;
    color: #888;
    margin-top: 5px;
}
.comment-empty {
    text-align: center;
    color: #888;
    padding: 20px;
}
.profile-section {
    display: none;
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.profile-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}
.profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--blue);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
}
.profile-info h2 {
    margin: 0 0 5px 0;
    color: var(--red);
}
.profile-stats {
    display: flex;
    gap: 20px;
    color: #666;
}
.profile-stats div {
    text-align: center;
}
.profile-stats span {
    display: block;
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--blue);
}
.back-btn {
    background: var(--gray);
    padding: 6px 15px;
    font-size: 0.9rem;
    margin-bottom: 15px;
}
</style>
</head>
<body>

<header>
    <h2 style="color:var(--red); margin:0;">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ±</h2>
    <div id="nav">
        <button class="btn" onclick="openAuth()">Ø¯Ø®ÙˆÙ„</button>
    </div>
</header>

<div class="container">
    <div id="upSection" class="upload-card">
        <h3 style="margin-top:0;">Ù†Ø´Ø± ÙÙŠØ¯ÙŠÙˆ</h3>
        <input type="text" id="vTitle" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <input type="file" id="vFile" accept="video/*">
        <button id="upBtn" class="btn" style="width:100%">Ø±ÙØ¹ Ø§Ù„Ø¢Ù†</button>
    </div>
    
    <div id="profileSection" class="profile-section">
        <button class="back-btn" onclick="showHome()">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <div class="profile-header">
            <div class="profile-avatar" id="profileAvatar">ğŸ‘¤</div>
            <div class="profile-info">
                <h2 id="profileName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
                <p id="profileEmail">user@example.com</p>
            </div>
        </div>
        <div class="profile-stats">
            <div>
                <span id="videoCount">0</span>
                <small>ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</small>
            </div>
            <div>
                <span id="totalViews">0</span>
                <small>Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</small>
            </div>
            <div>
                <span id="totalLikes">0</span>
                <small>Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª</small>
            </div>
        </div>
        <h3 style="margin:20px 0 10px 0; color:var(--red);">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§ØªÙŠ</h3>
        <div id="userVideos">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</div>
    </div>
    
    <div id="homeSection">
        <div id="list">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
</div>

<div id="aModal" class="modal">
    <div class="modal-box" id="modalBox">
        <h3 id="aTitle">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
        <input type="text" id="aUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="display:none">
        <input type="email" id="aEmail" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
        <input type="password" id="aPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button id="aConfirmBtn" class="btn" style="width:100%">ØªØ£ÙƒÙŠØ¯</button>
        <p onclick="toggleA()" style="color:blue; cursor:pointer; font-size:0.8rem; margin-top:10px;">ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</p>
        <div id="authError" style="color:red; margin-top:10px; min-height:20px;"></div>
    </div>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
const S_URL = 'https://dirvquetzoqenqzezqhr.supabase.co';
const S_KEY = 'sb_publishable_eeDbQM7zyLYW_8qKBzkbhg_9LduTmqw';
const client = supabase.createClient(S_URL, S_KEY);

let user = null;
let isSign = false;
let currentView = 'home';
const videoSessions = new Map();
const activeComments = new Set();

async function init() {
    try {
        const { data: { user: currentUser }, error } = await client.auth.getUser();
        if (error) {
            console.warn('auth.getUser error', error);
        }
        user = currentUser;

        if (user) {
            const name = user.user_metadata?.display_name || "Ù…Ø³ØªØ®Ø¯Ù…";
            const firstLetter = name.charAt(0).toUpperCase();
            
            document.getElementById('nav').innerHTML = `
                <button class="btn" onclick="showProfile()" style="background:#666; margin-left:8px;">Ù…Ù„ÙÙŠ</button>
                <span>@${escapeHtml(name)}</span> 
                <button id="logoutBtn" class="btn" style="background:#666; margin-right:8px;">Ø®Ø±ÙˆØ¬</button>`;
            
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await client.auth.signOut();
                location.reload();
            });
            
            document.getElementById('upSection').style.display = 'block';
            document.body.classList.add('user-authenticated');
            
            document.getElementById('profileAvatar').textContent = firstLetter;
            document.getElementById('profileName').textContent = name;
            document.getElementById('profileEmail').textContent = user.email;
        } else {
            document.getElementById('nav').innerHTML = `<button class="btn" onclick="openAuth()">Ø¯Ø®ÙˆÙ„</button>`;
            document.body.classList.remove('user-authenticated');
        }
    } catch (e) {
        console.error('init error', e);
        document.getElementById('list').innerHTML = `<div class="error-message">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ${e.message}</div>`;
    }

    if (currentView === 'home') {
        await loadVideos();
    } else {
        await loadUserProfile();
    }
}

async function loadVideos() {
    const div = document.getElementById('list');
    div.innerHTML = '<div style="text-align:center; padding:30px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... <div class="loading-spinner"></div></div>';
    
    try {
        // Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const { data: videos, error } = await client
            .from('video_files')
            .select('id, title, url, username, views, likes, created_at')
            .order('created_at', { ascending: false });

        if (error) {
            throw new Error(error.message || 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª');
        }

        if (!videos || videos.length === 0) {
            div.innerHTML = "<div style='text-align: center; padding: 30px;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.</div>";
            return;
        }

        const frag = document.createDocumentFragment();
        videos.forEach(v => {
            const videoDiv = document.createElement('div');
            videoDiv.className = "video-item";
            const viewCount = v.views || 0;
            const likeCount = v.likes || 0;
            
            videoDiv.innerHTML = `
                <video 
                    src="${escapeHtml(v.url)}" 
                    controls 
                    data-id="${v.id}"
                    onplay="startViewTracking(${v.id}, this)"
                    onpause="endViewTracking(${v.id})"
                    onended="endViewTracking(${v.id})"
                ></video>
                <div class="p-15">
                    <b>${escapeHtml(v.title)}</b>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; color:#777; font-size:0.9rem;">
                        <span>Ø¨ÙˆØ§Ø³Ø·Ø©: ${escapeHtml(v.username || 'Ù…Ø³ØªØ®Ø¯Ù…')}</span>
                        <span>${new Date(v.created_at).toLocaleDateString('ar-EG')}</span>
                    </div>
                </div>
                <div class="video-stats">
                    <div class="stats-container">
                        <button class="stat-btn" title="Ù…Ø´Ø§Ù‡Ø¯Ø§Øª" disabled>
                            <span>ğŸ‘€</span> <span>${formatNumber(viewCount)}</span>
                        </button>
                        <button class="stat-btn" title="Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª" disabled>
                            <span>â¤ï¸</span> <span>${formatNumber(likeCount)}</span>
                        </button>
                        <button class="stat-btn" title="ØªØ¹Ù„ÙŠÙ‚Ø§Øª" disabled>
                            <span>ğŸ’¬</span> <span>0</span>
                        </button>
                    </div>
                    <div class="authenticated-only">
                        ${user?.user_metadata?.display_name === v.username ? `<button class="btn" style="background:#666; padding:3px 8px; font-size:0.8rem;">Ø­Ø°Ù</button>` : ''}
                    </div>
                </div>`;
            frag.appendChild(videoDiv);
        });
        
        div.innerHTML = "";
        div.appendChild(frag);
        
    } catch (e) {
        console.error('loadVideos error', e);
        div.innerHTML = `<div class="error-message">
            <h3>âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>
            <p>${e.message}</p>
            <button class="btn" onclick="location.reload()" style="margin-top:15px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        </div>`;
    }
}

function showProfileSection() {
    document.getElementById('homeSection').style.display = 'none';
    document.getElementById('profileSection').style.display = 'block';
    currentView = 'profile';
    document.title = "Ù…Ù„ÙÙŠ - ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ±";
}

function showHome() {
    document.getElementById('profileSection').style.display = 'none';
    document.getElementById('homeSection').style.display = 'block';
    currentView = 'home';
    document.title = "ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©";
    loadVideos();
}

function showProfile() {
    if (!user) {
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        openAuth();
        return;
    }
    showProfileSection();
    loadUserProfile();
}

async function loadUserProfile() {
    if (!user) return;
    
    const videosDiv = document.getElementById('userVideos');
    videosDiv.innerHTML = '<div style="text-align:center; padding:20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª... <div class="loading-spinner"></div></div>';
    
    try {
        const username = user.user_metadata?.display_name || "Ù…Ø³ØªØ®Ø¯Ù…";
        const { data: userVideos, error } = await client
            .from('video_files')
            .select('id, title, url, views, likes, created_at')
            .eq('username', username)
            .order('created_at', { ascending: false });

        if (error) throw error;
        
        let totalVideos = 0;
        let totalViews = 0;
        let totalLikes = 0;
        
        if (userVideos && userVideos.length > 0) {
            totalVideos = userVideos.length;
            totalViews = userVideos.reduce((sum, video) => sum + (video.views || 0), 0);
            totalLikes = userVideos.reduce((sum, video) => sum + (video.likes || 0), 0);
            
            let videosHTML = '';
            userVideos.forEach(v => {
                videosHTML += `
                    <div class="video-item" style="margin-bottom:15px;">
                        <video src="${escapeHtml(v.url)}" controls style="width:100%; aspect-ratio:16/9; background:#000;"></video>
                        <div class="p-15">
                            <b>${escapeHtml(v.title)}</b>
                            <div style="display:flex; justify-content:space-between; margin-top:10px; color:#777; font-size:0.9rem;">
                                <span>ØªÙ… Ø§Ù„Ù†Ø´Ø±: ${new Date(v.created_at).toLocaleDateString('ar-EG')}</span>
                            </div>
                            <div class="video-stats">
                                <div class="stats-container">
                                    <button class="stat-btn" title="Ù…Ø´Ø§Ù‡Ø¯Ø§Øª" disabled>
                                        <span>ğŸ‘€</span> <span>${formatNumber(v.views || 0)}</span>
                                    </button>
                                    <button class="stat-btn" title="Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª" disabled>
                                        <span>â¤ï¸</span> <span>${formatNumber(v.likes || 0)}</span>
                                    </button>
                                </div>
                                <button class="btn" style="background:#666; padding:3px 8px; font-size:0.8rem;">Ø­Ø°Ù</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            videosDiv.innerHTML = videosHTML;
        } else {
            videosDiv.innerHTML = "<div style='text-align: center; padding: 30px; color:#888;'>Ù„Ù… ØªÙ‚Ù… Ø¨Ø±ÙØ¹ Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¨Ø¹Ø¯</div>";
        }
        
        document.getElementById('videoCount').textContent = totalVideos;
        document.getElementById('totalViews').textContent = formatNumber(totalViews);
        document.getElementById('totalLikes').textContent = formatNumber(totalLikes);
        
    } catch (e) {
        console.error('Error loading user profile:', e);
        videosDiv.innerHTML = `<div class="error-message">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§ØªÙƒ: ${e.message}</div>`;
    }
}

function startViewTracking(videoId, videoElement) {
    if (!user) return;
    
    if (videoSessions.has(videoId)) {
        endViewTracking(videoId);
    }
    
    const sessionId = Date.now();
    videoSessions.set(videoId, {
        id: sessionId,
        startTime: Date.now(),
        element: videoElement,
        timeout: setTimeout(() => {
            if (videoSessions.get(videoId)?.id === sessionId) {
                recordView(videoId);
                videoSessions.delete(videoId);
            }
        }, 3000)
    });
}

function endViewTracking(videoId) {
    const session = videoSessions.get(videoId);
    if (session) {
        clearTimeout(session.timeout);
        videoSessions.delete(videoId);
    }
}

async function recordView(videoId) {
    try {
        const { error } = await client
            .from('video_files')
            .update({ views: supabase.rpc('increment') })
            .eq('id', videoId);
        
        if (error) {
            console.error('View update error:', error);
        }
    } catch (e) {
        console.error('Error in incrementView:', e);
    }
}

document.getElementById('upBtn').addEventListener('click', async () => {
    const t = document.getElementById('vTitle').value.trim();
    const fileInput = document.getElementById('vFile');
    const f = fileInput.files[0];
    const btn = document.getElementById('upBtn');
    
    if (!t || !f) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ");
    if (!user) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");

    btn.disabled = true;
    btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... <div class='loading-spinner' style='display:inline-block; width:16px; height:16px; margin-left:10px;'></div>";

    try {
        const path = `${Date.now()}_${sanitizeFilename(f.name)}`;
        const { error: uploadError } = await client.storage
            .from('videos')
            .upload(path, f, { upsert: true });
        
        if (uploadError) throw uploadError;

        const { data } = await client.storage
            .from('videos')
            .getPublicUrl(path);
        
        const publicUrl = data?.publicUrl;
        if (!publicUrl) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¹Ø§Ù…');

        const username = user.user_metadata?.display_name || `Ù…Ø³ØªØ®Ø¯Ù…_${Date.now().toString(36).slice(2, 8)}`;
        
        const { error: dbError } = await client.from('video_files').insert([{
            title: t,
            url: publicUrl,
            path: path,
            username: username,
            views: 0,
            likes: 0
        }]);
        
        if (dbError) throw dbError;

        if (currentView === 'home') {
            await loadVideos();
        } else {
            await loadUserProfile();
        }

        btn.disabled = false;
        btn.innerHTML = "Ø±ÙØ¹ Ø§Ù„Ø¢Ù†";
        document.getElementById('vTitle').value = "";
        fileInput.value = "";
        
        alert("ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!");

    } catch (e) {
        console.error('Upload error', e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: " + (e.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        btn.disabled = false;
        btn.innerHTML = "Ø±ÙØ¹ Ø§Ù„Ø¢Ù†";
    }
});

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function openAuth() { 
    document.getElementById('aModal').style.display = 'flex';
    document.getElementById('authError').textContent = '';
}

function toggleA() {
    isSign = !isSign;
    document.getElementById('aTitle').innerText = isSign ? "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" : "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„";
    const userInput = document.getElementById('aUser');
    userInput.style.display = isSign ? "block" : "none";
    userInput.value = "";
    document.getElementById('authError').textContent = '';
}

document.getElementById('aConfirmBtn').addEventListener('click', async () => {
    const e = document.getElementById('aEmail').value.trim();
    const p = document.getElementById('aPass').value;
    const u = document.getElementById('aUser').value.trim();
    const errorEl = document.getElementById('authError');

    if (!e || !p) {
        errorEl.textContent = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
        return;
    }
    if (isSign && !u) {
        errorEl.textContent = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        return;
    }

    try {
        const btn = document.getElementById('aConfirmBtn');
        btn.disabled = true;
        btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©... <div class='loading-spinner' style='display:inline-block; width:16px; height:16px; margin-left:10px;'></div>";
        errorEl.textContent = '';

        if (isSign) {
            const { error } = await client.auth.signUp({ 
                email: e, 
                password: p, 
                options: { 
                    data: { 
                        display_name: u || `user_${Date.now().toString(36).slice(2, 8)}` 
                    } 
                } 
            });
            if (error) throw error;
        } else {
            const { error } = await client.auth.signInWithPassword({ email: e, password: p });
            if (error) throw error;
        }
        
        document.getElementById('aModal').style.display = 'none';
        await init();
    } catch (err) {
        console.error('Auth error', err);
        const msg = err?.error?.message || err?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©';
        errorEl.textContent = msg;
    } finally {
        const btn = document.getElementById('aConfirmBtn');
        btn.disabled = false;
        btn.innerHTML = "ØªØ£ÙƒÙŠØ¯";
    }
});

document.getElementById('aModal').addEventListener('click', (e) => {
    if (e.target.id === 'aModal') {
        document.getElementById('aModal').style.display = 'none';
    }
});

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function sanitizeFilename(name) {
    return name.replace(/[^a-zA-Z0-9.\-_Ø¡-ÙŠ ]/g, '_').replace(/\s+/g, '_');
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
