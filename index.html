<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø©</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #ff0000; --bg: #f4f4f4; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; direction: rtl; }
        header {
            background: #fff;
            padding: 12px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .btn { background: var(--red); color: #fff; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .upload-card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none; }
        input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .video-item { background: #fff; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        video { width: 100%; aspect-ratio: 16/9; background: #000; display: block; }
        .p-15 { padding: 15px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 380px; text-align: center; }
        .muted { color:#777; font-size:0.9rem; }
    </style>
</head>
<body>

<header>
    <h2 style="color:var(--red); margin:0;">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ±</h2>
    <div id="nav">
        <button class="btn" onclick="openAuth()">Ø¯Ø®ÙˆÙ„</button>
    </div>
</header>

<div class="container">
    <div id="upSection" class="upload-card" aria-hidden="true">
        <h3 style="margin-top:0;">Ù†Ø´Ø± ÙÙŠØ¯ÙŠÙˆ</h3>
        <input type="text" id="vTitle" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <input type="file" id="vFile" accept="video/*">
        <button id="upBtn" class="btn" style="width:100%" onclick="doUpload()">Ø±ÙØ¹ Ø§Ù„Ø¢Ù†</button>
    </div>
    <div id="list">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<div id="aModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-box">
        <h3 id="aTitle">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
        <input type="text" id="aUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="display:none">
        <input type="email" id="aEmail" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
        <input type="password" id="aPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn" style="width:100%" onclick="auth()">ØªØ£ÙƒÙŠØ¯</button>
        <p onclick="toggleA()" style="color:blue; cursor:pointer; font-size:0.8rem; margin-top:10px;">ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</p>
    </div>
</div>

<script>
    // ØªÙƒÙˆÙŠÙ† Supabase
    const S_URL = 'https://dirvquetzoqenqzezqhr.supabase.co';
    const S_KEY = 'sb_publishable_eeDbQM7zyLYW_8qKBzkbhg_9LduTmqw'; // ØªØ£ÙƒØ¯ Ø¥Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ù…ÙØªØ§Ø­ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© (anon/publishable)
    const client = supabase.createClient(S_URL, S_KEY);

    let user = null;
    let isSign = false;

    // ØªØ¹Ù‚ÙŠÙ… Ø¨Ø³ÙŠØ· Ù„Ù„Ù†Øµ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠ innerHTML
    function esc(str) {
        if (str == null) return '';
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }

    async function signOut() {
        try {
            await client.auth.signOut();
        } catch(e) {
            console.error('signOut error', e);
        }
        location.reload();
    }

    async function init() {
        try {
            const res = await client.auth.getUser();
            // res.data.user Ø£Ùˆ Ø­Ø³Ø¨ ØµÙŠØºØ© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
            user = res?.data?.user || null;
            const nav = document.getElementById('nav');
            if (user) {
                const name = user.user_metadata?.display_name || user.email || 'Ù…Ø³ØªØ®Ø¯Ù…';
                nav.innerHTML = `<span>@${esc(name)}</span> <button class="btn" style="background:#666; margin-right:8px;" onclick="signOut()">Ø®Ø±ÙˆØ¬</button>`;
                document.getElementById('upSection').style.display = 'block';
                document.getElementById('upSection').setAttribute('aria-hidden', 'false');
            } else {
                nav.innerHTML = `<button class="btn" onclick="openAuth()">Ø¯Ø®ÙˆÙ„</button>`;
                document.getElementById('upSection').style.display = 'none';
            }
        } catch (e) {
            console.error('init auth error', e);
        }
        await load();
    }

    async function load() {
        const div = document.getElementById('list');
        div.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        try {
            const { data, error } = await client
                .from('video_files')
                .select('*')
                .order('id', { ascending: false });

            if (error) throw error;
            if (!data || data.length === 0) {
                div.innerHTML = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.';
                return;
            }

            div.innerHTML = '';
            data.forEach(v => {
                // Ù†Ø¹Ù‚Ù… Ø§Ù„Ù†ØµÙˆØµ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬
                const id = esc(v.id);
                const title = esc(v.title);
                const username = esc(v.username);
                const views = esc(v.views || 0);
                const url = esc(v.url);

                const item = document.createElement('div');
                item.className = 'video-item';
                item.innerHTML = `
                    <video src="${url}" controls onplay="hitView('${id}')"></video>
                    <div class="p-15">
                        <b>${title}</b>
                        <div style="display:flex; justify-content:space-between; margin-top:10px;" class="muted">
                            <span>Ø¨ÙˆØ§Ø³Ø·Ø©: ${username}</span>
                            <span>ğŸ‘ï¸ <span id="c-${id}">${views}</span></span>
                        </div>
                    </div>`;
                div.appendChild(item);
            });
        } catch (e) {
            console.error(e);
            div.innerHTML = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.';
        }
    }

    async function hitView(id) {
        try {
            let history = JSON.parse(sessionStorage.getItem('seen') || '[]');
            if (history.includes(id)) return;

            const { error } = await client.rpc('increment_views', { row_id: id });
            if (error) {
                console.error('RPC error', error);
                return;
            }

            history.push(id);
            sessionStorage.setItem('seen', JSON.stringify(history));

            const span = document.getElementById(`c-${id}`);
            if (span) span.innerText = String(parseInt(span.innerText || '0') + 1);
        } catch (e) {
            console.error('hitView error', e);
        }
    }

    async function doUpload() {
        const t = document.getElementById('vTitle').value.trim();
        const f = document.getElementById('vFile').files[0];
        if (!t || !f) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        const btn = document.getElementById('upBtn');
        btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";

        try {
            const path = Date.now() + "_" + f.name.replace(/\s+/g, '_');
            const { data: uploadData, error: uploadError } = await client.storage.from('videos').upload(path, f);
            if (uploadError) throw uploadError;

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø¹Ø§Ù…
            const { data: publicData } = client.storage.from('videos').getPublicUrl(path);
            const publicUrl = publicData?.publicUrl || publicData?.publicURL || null;
            if (!publicUrl) throw new Error('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù');

            const username = user?.user_metadata?.display_name || user?.email || 'Ù…Ø¬Ù‡ÙˆÙ„';
            const { error: insertError } = await client.from('video_files').insert([{ title: t, url: publicUrl, username }]);
            if (insertError) throw insertError;

            location.reload();
        } catch (e) {
            console.error('upload error', e);
            alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: " + (e.message || e));
            btn.disabled = false;
            btn.innerText = "Ø±ÙØ¹ Ø§Ù„Ø¢Ù†";
        }
    }

    function openAuth() { document.getElementById('aModal').style.display = 'flex'; }
    function closeAuth() { document.getElementById('aModal').style.display = 'none'; }

    function toggleA() {
        isSign = !isSign;
        document.getElementById('aTitle').innerText = isSign ? "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" : "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„";
        document.getElementById('aUser').style.display = isSign ? 'block' : 'none';
    }

    async function auth() {
        const e = document.getElementById('aEmail').value.trim();
        const p = document.getElementById('aPass').value;
        const u = document.getElementById('aUser').value.trim();

        if (!e || !p || (isSign && !u)) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');

        try {
            if (isSign) {
                const { error } = await client.auth.signUp({ email: e, password: p, options: { data: { display_name: u } } });
                if (error) throw error;
                alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ù‚Ù… Ø¨ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±.');
            } else {
                const { error } = await client.auth.signInWithPassword({ email: e, password: p });
                if (error) throw error;
            }
            location.reload();
        } catch (err) {
            console.error('auth error', err);
            alert(err?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
        }
    }

    // Ø¨Ø¯Ø§ÙŠØ©
    init();
</script>
</body>
</html>
