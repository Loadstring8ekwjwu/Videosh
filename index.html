<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --red: #ff0000; --bg: #f4f4f4; --yellow: #ffc107; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; direction: rtl; }
header { background: #fff; padding: 12px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
.btn { background: var(--red); color: #fff; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; font-weight: bold; }
.container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
.upload-card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none; }
input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; }
.video-item { background: #fff; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }
video { width: 100%; aspect-ratio: 16/9; background: #000; display: block; }
.p-15 { padding: 15px; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
.modal-box { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 380px; text-align: center; }
.video-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    padding: 0 15px 15px;
    color: #666;
    font-size: 0.9rem;
}
.like-btn {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 5px;
}
.like-btn.liked {
    color: var(--yellow);
}
.views-count {
    display: flex;
    align-items: center;
    gap: 5px;
}
.stats-container {
    display: flex;
    gap: 20px;
}
.authenticated-only { display: none; }
.user-authenticated .authenticated-only { display: inline-block; }
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.error-message {
    color: red;
    text-align: center;
    padding: 20px;
    border: 1px solid #ffdddd;
    border-radius: 8px;
    background: #fff9f9;
    margin: 10px;
}
</style>
</head>
<body>

<header>
    <h2 style="color:var(--red); margin:0;">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ±</h2>
    <div id="nav">
        <button class="btn" onclick="openAuth()">Ø¯Ø®ÙˆÙ„</button>
    </div>
</header>

<div class="container">
    <div id="upSection" class="upload-card">
        <h3 style="margin-top:0;">Ù†Ø´Ø± ÙÙŠØ¯ÙŠÙˆ</h3>
        <input type="text" id="vTitle" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <input type="file" id="vFile" accept="video/*">
        <button id="upBtn" class="btn" style="width:100%">Ø±ÙØ¹ Ø§Ù„Ø¢Ù†</button>
    </div>
    <div id="list">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<div id="aModal" class="modal">
    <div class="modal-box" id="modalBox">
        <h3 id="aTitle">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
        <input type="text" id="aUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="display:none">
        <input type="email" id="aEmail" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
        <input type="password" id="aPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button id="aConfirmBtn" class="btn" style="width:100%">ØªØ£ÙƒÙŠØ¯</button>
        <p onclick="toggleA()" style="color:blue; cursor:pointer; font-size:0.8rem; margin-top:10px;">ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</p>
        <div id="authError" style="color:red; margin-top:10px; min-height:20px;"></div>
    </div>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
const S_URL = 'https://dirvquetzoqenqzezqhr.supabase.co';
const S_KEY = 'sb_publishable_eeDbQM7zyLYW_8qKBzkbhg_9LduTmqw';
const client = supabase.createClient(S_URL, S_KEY);

let user = null;
let isSign = false;
const viewedVideos = new Set();
const likedVideos = new Set();

// Ø¯Ø§Ù„Ø© ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function checkDatabaseStructure() {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ video_likes
        const { data: tables, error: tablesError } = await client
            .from('information_schema.tables')
            .select('table_name')
            .eq('table_name', 'video_likes');
        
        if (tablesError) {
            console.error('Database check error:', tablesError);
            return false;
        }
        
        if (!tables || tables.length === 0) {
            console.warn('Table video_likes does not exist');
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('Database structure check failed:', error);
        return false;
    }
}

// Ø¯Ø§Ù„Ø© Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function fixDatabaseStructure() {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹
        const isStructured = await checkDatabaseStructure();
        if (isStructured) return true;
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¯ÙˆØ§Ù„
        const createTableQuery = `
            CREATE TABLE IF NOT EXISTS video_likes (
                id SERIAL PRIMARY KEY,
                video_id INTEGER NOT NULL REFERENCES video_files(id) ON DELETE CASCADE,
                user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                UNIQUE(video_id, user_id)
            );
        `;
        
        await client.rpc('execute_sql', { sql: createTableQuery });
        
        // Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        const grantPermissionsQuery = `
            GRANT SELECT, INSERT, DELETE ON video_likes TO authenticated;
            GRANT USAGE ON SEQUENCE video_likes_id_seq TO authenticated;
        `;
        
        await client.rpc('execute_sql', { sql: grantPermissionsQuery });
        
        return true;
    } catch (error) {
        console.error('Database fix failed:', error);
        return false;
    }
}

async function init() {
    try {
        const { data: { user: currentUser }, error } = await client.auth.getUser();
        if (error) {
            console.warn('auth.getUser error', error);
        }
        user = currentUser;

        if (user) {
            const name = user.user_metadata?.display_name || "Ù…Ø³ØªØ®Ø¯Ù…";
            document.getElementById('nav').innerHTML = `<span>@${escapeHtml(name)}</span> <button id="logoutBtn" class="btn" style="background:#666; margin-right:8px;">Ø®Ø±ÙˆØ¬</button>`;
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await client.auth.signOut();
                location.reload();
            });
            document.getElementById('upSection').style.display = 'block';
            document.body.classList.add('user-authenticated');
        } else {
            document.getElementById('nav').innerHTML = `<button class="btn" onclick="openAuth()">Ø¯Ø®ÙˆÙ„</button>`;
            document.body.classList.remove('user-authenticated');
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥ØµÙ„Ø§Ø­Ù‡ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        await fixDatabaseStructure();
        
    } catch (e) {
        console.error('init error', e);
        document.getElementById('list').innerHTML = `<div class="error-message">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ${e.message}</div>`;
    }

    await loadVideos();
}

async function loadVideos() {
    const div = document.getElementById('list');
    div.innerHTML = '<div style="text-align:center; padding:30px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... <div class="loading-spinner"></div></div>';
    
    try {
        // Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        const { data: videos, error: videosError } = await client
            .from('video_files')
            .select('id, title, url, username, views, created_at, path')
            .order('created_at', { ascending: false });
        
        if (videosError) {
            console.error('Videos fetch error:', videosError);
            throw new Error(videosError.message || 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª');
        }
        
        if (!videos || videos.length === 0) {
            div.innerHTML = "<div style='text-align: center; padding: 30px;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.</div>";
            return;
        }

        // Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        let userLikes = [];
        if (user) {
            try {
                const { data, error } = await client
                    .from('video_likes')
                    .select('video_id')
                    .eq('user_id', user.id);
                
                if (!error && data) {
                    userLikes = data;
                    userLikes.forEach(like => likedVideos.add(like.video_id));
                }
            } catch (likesError) {
                console.error('User likes fetch error:', likesError);
            }
        }

        // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        const videoIds = videos.map(v => v.id);
        const likesCount = {};
        
        try {
            const { data: likesData, error: likesError } = await client
                .from('video_likes')
                .select('video_id')
                .in('video_id', videoIds);
            
            if (!likesError && likesData) {
                likesData.forEach(like => {
                    likesCount[like.video_id] = (likesCount[like.video_id] || 0) + 1;
                });
            }
        } catch (countError) {
            console.error('Likes count fetch error:', countError);
        }

        const frag = document.createDocumentFragment();
        videos.forEach(v => {
            const videoDiv = document.createElement('div');
            videoDiv.className = "video-item";
            const viewCount = v.views || 0;
            const likeCount = likesCount[v.id] || 0;
            const isLiked = likedVideos.has(v.id);
            
            videoDiv.innerHTML = `
                <video 
                    src="${escapeHtml(v.url)}" 
                    controls 
                    data-id="${v.id}"
                    onplay="trackView(${v.id}, this)"
                    ${user ? '' : 'preload="metadata"'}
                ></video>
                <div class="p-15">
                    <b>${escapeHtml(v.title)}</b>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; color:#777; font-size:0.9rem;">
                        <span>Ø¨ÙˆØ§Ø³Ø·Ø©: ${escapeHtml(v.username || 'Ù…Ø³ØªØ®Ø¯Ù…')}</span>
                        <span>${new Date(v.created_at).toLocaleDateString('ar-EG')}</span>
                    </div>
                </div>
                <div class="video-stats">
                    <div class="stats-container">
                        <div class="views-count">
                            <span>ğŸ‘€</span> <span class="view-count-${v.id}">${formatNumber(viewCount)}</span>
                        </div>
                        <button class="like-btn ${isLiked ? 'liked' : ''}" 
                                data-id="${v.id}" 
                                onclick="toggleLike(${v.id}, this)">
                            <span>â¤ï¸</span> <span class="like-count-${v.id}">${formatNumber(likeCount)}</span>
                        </button>
                    </div>
                    <div class="authenticated-only">
                        ${user?.user_metadata?.display_name === v.username ? `<button class="btn" style="background:#666; padding:3px 8px; font-size:0.8rem;" onclick="deleteVideo(${v.id})">Ø­Ø°Ù</button>` : ''}
                    </div>
                </div>`;
            frag.appendChild(videoDiv);
        });
        
        div.innerHTML = "";
        div.appendChild(frag);
        
    } catch (e) {
        console.error('loadVideos error', e);
        div.innerHTML = `<div class="error-message">
            <h3>âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>
            <p>${e.message}</p>
            <p>ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ:</p>
            <ul style="text-align:left; margin:15px 0;">
                <li>Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                <li>ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„</li>
                <li>Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase</li>
            </ul>
            <button class="btn" onclick="location.reload()" style="margin-top:15px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        </div>`;
    }
}

function trackView(videoId, videoElement) {
    if (viewedVideos.has(videoId)) return;
    
    const handler = () => {
        if (videoElement.currentTime > 3 && !viewedVideos.has(videoId)) {
            viewedVideos.add(videoId);
            incrementView(videoId);
            videoElement.removeEventListener('timeupdate', handler);
        }
    };
    
    videoElement.addEventListener('timeupdate', handler);
    videoElement.addEventListener('pause', () => {
        videoElement.removeEventListener('timeupdate', handler);
    });
}

async function incrementView(videoId) {
    try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const countElement = document.querySelector(`.view-count-${videoId}`);
        if (!countElement) return;
        
        const currentCount = parseInt(countElement.textContent.replace(/,/g, '')) || 0;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        countElement.textContent = formatNumber(currentCount + 1);
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { error } = await client
            .from('video_files')
            .update({ views: currentCount + 1 })
            .eq('id', videoId);
        
        if (error) {
            console.error('View update error:', error);
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            countElement.textContent = formatNumber(currentCount);
        }
    } catch (e) {
        console.error('Error in incrementView:', e);
    }
}

async function toggleLike(videoId, element) {
    if (!user) {
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¨Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª");
        openAuth();
        return;
    }
    
    const isLiked = element.classList.contains('liked');
    const countElement = element.querySelector(`.like-count-${videoId}`);
    if (!countElement) return;
    
    let currentCount = parseInt(countElement.textContent.replace(/,/g, '')) || 0;
    
    try {
        if (isLiked) {
            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
            const { error } = await client
                .from('video_likes')
                .delete()
                .match({ 
                    video_id: videoId, 
                    user_id: user.id 
                });
            
            if (error) throw error;
            
            element.classList.remove('liked');
            likedVideos.delete(videoId);
            countElement.textContent = formatNumber(currentCount - 1);
        } else {
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¬Ø§Ø¨
            const { error } = await client
                .from('video_likes')
                .insert([
                    { 
                        video_id: videoId, 
                        user_id: user.id 
                    }
                ]);
            
            if (error) throw error;
            
            element.classList.add('liked');
            likedVideos.add(videoId);
            countElement.textContent = formatNumber(currentCount + 1);
        }
    } catch (e) {
        console.error('Error toggling like:', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨: ' + (e.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        countElement.textContent = formatNumber(currentCount);
        if (isLiked) {
            element.classList.add('liked');
            likedVideos.add(videoId);
        } else {
            element.classList.remove('liked');
            likedVideos.delete(videoId);
        }
    }
}

async function deleteVideo(videoId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ')) return;
    
    try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        const {  video, error: fetchError } = await client
            .from('video_files')
            .select('path, url')
            .eq('id', videoId)
            .single();
        
        if (fetchError) throw fetchError;
        
        // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
        if (video.path) {
            const { error: storageError } = await client.storage
                .from('videos')
                .remove([video.path]);
            
            if (storageError) {
                console.warn('Storage delete error:', storageError);
            }
        }
        
        // Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { error: dbError } = await client
            .from('video_files')
            .delete()
            .eq('id', videoId);
            
        if (dbError) throw dbError;
        
        // Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        await client.from('video_likes').delete().eq('video_id', videoId);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        await loadVideos();
        
        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!');
    } catch (e) {
        console.error('Error deleting video', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ' + e.message);
    }
}

document.getElementById('upBtn').addEventListener('click', doUpload);
async function doUpload() {
    const t = document.getElementById('vTitle').value.trim();
    const fileInput = document.getElementById('vFile');
    const f = fileInput.files[0];
    const btn = document.getElementById('upBtn');
    
    if (!t || !f) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ");
    if (!user) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");

    btn.disabled = true;
    btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... <div class='loading-spinner' style='display:inline-block; width:16px; height:16px; margin-left:10px;'></div>";

    try {
        const path = `${Date.now()}_${sanitizeFilename(f.name)}`;
        const { data: uploadData, error: uploadError } = await client.storage
            .from('videos')
            .upload(path, f, { upsert: true });
        
        if (uploadError) throw uploadError;

        const { data: publicData } = await client.storage
            .from('videos')
            .getPublicUrl(path);
        
        const publicUrl = publicData?.publicUrl;
        if (!publicUrl) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¹Ø§Ù…');

        const username = user.user_metadata?.display_name || `Ù…Ø³ØªØ®Ø¯Ù…_${Date.now().toString(36).slice(2, 8)}`;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹ ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const { error: dbError } = await client.from('video_files').insert([{
            title: t,
            url: publicUrl,
            path: path,
            username: username,
            views: 0,
            created_at: new Date().toISOString()
        }]);
        
        if (dbError) throw dbError;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        await loadVideos();

        btn.disabled = false;
        btn.innerHTML = "Ø±ÙØ¹ Ø§Ù„Ø¢Ù†";
        document.getElementById('vTitle').value = "";
        fileInput.value = "";
        
        alert("ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!");

    } catch (e) {
        console.error('Upload error', e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: " + (e.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        btn.disabled = false;
        btn.innerHTML = "Ø±ÙØ¹ Ø§Ù„Ø¢Ù†";
    }
}

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function openAuth() { 
    document.getElementById('aModal').style.display = 'flex';
    document.getElementById('authError').textContent = '';
}

function toggleA() {
    isSign = !isSign;
    document.getElementById('aTitle').innerText = isSign ? "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" : "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„";
    const userInput = document.getElementById('aUser');
    userInput.style.display = isSign ? "block" : "none";
    userInput.value = "";
    document.getElementById('authError').textContent = '';
}

document.getElementById('aConfirmBtn').addEventListener('click', auth);
async function auth() {
    const e = document.getElementById('aEmail').value.trim();
    const p = document.getElementById('aPass').value;
    const u = document.getElementById('aUser').value.trim();
    const errorEl = document.getElementById('authError');

    if (!e || !p) {
        errorEl.textContent = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
        return;
    }
    if (isSign && !u) {
        errorEl.textContent = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        return;
    }

    try {
        const btn = document.getElementById('aConfirmBtn');
        btn.disabled = true;
        btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©... <div class='loading-spinner' style='display:inline-block; width:16px; height:16px; margin-left:10px;'></div>";
        errorEl.textContent = '';

        let authResult;
        if (isSign) {
            authResult = await client.auth.signUp({ 
                email: e, 
                password: p, 
                options: { 
                    data: { 
                        display_name: u || `user_${Date.now().toString(36).slice(2, 8)}` 
                    } 
                } 
            });
        } else {
            authResult = await client.auth.signInWithPassword({ email: e, password: p });
        }
        
        if (authResult.error) throw authResult.error;

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø©
        document.getElementById('aModal').style.display = 'none';
        await init();
    } catch (err) {
        console.error('Auth error', err);
        const msg = err?.error?.message || err?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©';
        errorEl.textContent = msg;
    } finally {
        const btn = document.getElementById('aConfirmBtn');
        btn.disabled = false;
        btn.innerHTML = "ØªØ£ÙƒÙŠØ¯";
    }
}

document.getElementById('aModal').addEventListener('click', (e) => {
    if (e.target.id === 'aModal') {
        document.getElementById('aModal').style.display = 'none';
    }
});

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function sanitizeFilename(name) {
    return name.replace(/[^a-zA-Z0-9.\-_Ø¡-ÙŠ ]/g, '_').replace(/\s+/g, '_');
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
