<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --red: #ff0000; --bg: #f4f4f4; --yellow: #ffc107; --blue: #0d6efd; --gray: #6c757d; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; direction: rtl; }
header { background: #fff; padding: 12px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
.btn { background: var(--red); color: #fff; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; font-weight: bold; }
.container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
.upload-card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none; }
input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; }
.video-item { background: #fff; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }
video { width: 100%; aspect-ratio: 16/9; background: #000; display: block; }
.p-15 { padding: 15px; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
.modal-box { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 380px; text-align: center; }
.video-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    padding: 0 15px 15px;
    color: #666;
    font-size: 0.9rem;
}
.stat-btn {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border-radius: 15px;
    transition: all 0.2s;
}
.stat-btn:hover {
    background: #f5f5f5;
}
.stat-btn.liked {
    color: var(--yellow);
}
.stat-btn.comments-active {
    background: #e3f2fd;
    color: var(--blue);
}
.stats-container {
    display: flex;
    gap: 15px;
}
.authenticated-only { display: none; }
.user-authenticated .authenticated-only { display: inline-block; }
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.error-message {
    color: red;
    text-align: center;
    padding: 20px;
    border: 1px solid #ffdddd;
    border-radius: 8px;
    background: #fff9f9;
    margin: 10px;
}
.comments-section {
    padding: 0 15px 15px;
    border-top: 1px solid #eee;
    display: none;
}
.comment-input-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}
.comment-input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 20px;
    resize: none;
    direction: rtl;
}
.comment-btn {
    background: var(--blue);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
}
.comments-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.comment-item {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 12px;
    border-left: 3px solid var(--blue);
}
.comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}
.comment-content {
    line-height: 1.5;
    color: #555;
}
.comment-time {
    font-size: 0.8rem;
    color: #888;
    margin-top: 5px;
}
.comment-empty {
    text-align: center;
    color: #888;
    padding: 20px;
}
.profile-section {
    display: none;
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.profile-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}
.profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--blue);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
}
.profile-info h2 {
    margin: 0 0 5px 0;
    color: var(--red);
}
.profile-stats {
    display: flex;
    gap: 20px;
    color: #666;
}
.profile-stats div {
    text-align: center;
}
.profile-stats span {
    display: block;
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--blue);
}
.back-btn {
    background: var(--gray);
    padding: 6px 15px;
    font-size: 0.9rem;
    margin-bottom: 15px;
}
.search-container {
    position: relative;
    max-width: 500px;
    margin: 10px auto;
}
#searchInput {
    width: 100%;
    padding: 10px 15px 10px 35px;
    border-radius: 20px;
    border: 1px solid #ddd;
    font-size: 0.95rem;
    direction: rtl;
}
.search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #888;
}
.connection-test {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
    text-align: center;
}
</style>
</head>
<body>

<header>
    <h2 style="color:var(--red); margin:0;">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ±</h2>
    <div id="nav">
        <button class="btn" onclick="openAuth()">Ø¯Ø®ÙˆÙ„</button>
    </div>
</header>

<div class="container">
    <div class="search-container">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ù…Ø³ØªØ®Ø¯Ù…..." 
               oninput="filterLocally()">
    </div>
    
    <div id="upSection" class="upload-card">
        <h3 style="margin-top:0;">Ù†Ø´Ø± ÙÙŠØ¯ÙŠÙˆ</h3>
        <input type="text" id="vTitle" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <input type="file" id="vFile" accept="video/*">
        <button id="upBtn" class="btn" style="width:100%">Ø±ÙØ¹ Ø§Ù„Ø¢Ù†</button>
    </div>
    
    <div id="profileSection" class="profile-section">
        <button class="back-btn" onclick="showHome()">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <div class="profile-header">
            <div class="profile-avatar" id="profileAvatar">ğŸ‘¤</div>
            <div class="profile-info">
                <h2 id="profileName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
                <p id="profileEmail">user@example.com</p>
            </div>
        </div>
        <div class="profile-stats">
            <div>
                <span id="videoCount">0</span>
                <small>ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</small>
            </div>
            <div>
                <span id="totalViews">0</span>
                <small>Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</small>
            </div>
            <div>
                <span id="totalLikes">0</span>
                <small>Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª</small>
            </div>
        </div>
        <h3 style="margin:20px 0 10px 0; color:var(--red);">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§ØªÙŠ</h3>
        <div id="userVideos">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</div>
    </div>
    
    <div id="homeSection">
        <div id="list" class="connection-test">
            <button class="btn" onclick="initializeApp()" style="background:#4CAF50;">Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
            <p style="margin-top:10px; color:#666;">Ø§Ø¶ØºØ· Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</p>
        </div>
    </div>
</div>

<div id="aModal" class="modal">
    <div class="modal-box" id="modalBox">
        <h3 id="aTitle">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
        <input type="text" id="aUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="display:none">
        <input type="email" id="aEmail" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
        <input type="password" id="aPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button id="aConfirmBtn" class="btn" style="width:100%">ØªØ£ÙƒÙŠØ¯</button>
        <p onclick="toggleA()" style="color:blue; cursor:pointer; font-size:0.8rem; margin-top:10px;">ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</p>
        <div id="authError" style="color:red; margin-top:10px; min-height:20px;"></div>
    </div>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
const S_URL = 'https://dirvquetzoqenqzezqhr.supabase.co';
const S_KEY = 'sb_publishable_eeDbQM7zyLYW_8qKBzkbhg_9LduTmqw';
const client = supabase.createClient(S_URL, S_KEY);

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ©
let user = null;
let isSign = false;
let currentView = 'home';
let allVideos = []; // ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
let allComments = new Map(); // ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
let userLikes = new Set(); // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
let videoSessions = new Map(); // Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
let activeComments = new Set(); // Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©

// Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
async function initializeApp() {
    const div = document.getElementById('list');
    div.innerHTML = '<div style="text-align:center; padding:30px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... <div class="loading-spinner"></div></div>';
    
    try {
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { data: test, error: testError } = await client
            .from('video_files')
            .select('id')
            .limit(1);
        
        if (testError) {
            throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + testError.message);
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await Promise.all([
            loadAllVideos(),
            loadAllComments(),
            loadUserSession()
        ]);
        
        // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        displayVideos(allVideos);
        
    } catch (e) {
        console.error('Initialization error:', e);
        div.innerHTML = `<div class="error-message">
            <h3>âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <p>${e.message}</p>
            <p style="margin-top:15px; color:#666; font-size:0.9rem;">
                Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:<br>
                â€¢ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ video_files<br>
                â€¢ ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase<br>
                â€¢ Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            </p>
            <div style="margin-top:20px;">
                <button class="btn" onclick="initializeApp()" style="margin:0 5px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                <button class="btn" onclick="createTestData()" style="background:#2196F3; margin:0 5px;">Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
            </div>
        </div>`;
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
async function loadAllVideos() {
    try {
        const {  videos, error } = await client
            .from('video_files')
            .select('id, title, url, username, views, likes, created_at, path')
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        allVideos = videos || [];
    } catch (e) {
        console.error('Error loading videos:', e);
        allVideos = []; // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© ÙØ§Ø±ØºØ© Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø§Ù„ØªØ¹Ø·ÙŠÙ„
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
async function loadAllComments() {
    try {
        const {  comments, error } = await client
            .from('video_comments')
            .select('*');
        
        if (error) throw error;
        
        allComments = new Map();
        comments.forEach(comment => {
            if (!allComments.has(comment.video_id)) {
                allComments.set(comment.video_id, []);
            }
            allComments.get(comment.video_id).push(comment);
        });
    } catch (e) {
        console.error('Error loading comments:', e);
        allComments = new Map(); // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© ÙØ§Ø±ØºØ©
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function loadUserSession() {
    try {
        const {  { user: currentUser }, error } = await client.auth.getUser();
        
        if (!error && currentUser) {
            user = currentUser;
            setupUserInterface();
            
            // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const {  likes, error: likesError } = await client
                .from('video_likes')
                .select('video_id')
                .eq('user_id', user.id);
            
            if (!likesError && likes) {
                likes.forEach(like => userLikes.add(like.video_id));
            }
        }
    } catch (e) {
        console.error('Error loading user session:', e);
    }
}

// Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„
function setupUserInterface() {
    const name = user.user_metadata?.display_name || "Ù…Ø³ØªØ®Ø¯Ù…";
    const firstLetter = name.charAt(0).toUpperCase();
    
    document.getElementById('nav').innerHTML = `
        <button class="btn" onclick="showProfile()" style="background:#666; margin-left:8px;">Ù…Ù„ÙÙŠ</button>
        <span>@${escapeHtml(name)}</span> 
        <button id="logoutBtn" class="btn" style="background:#666; margin-right:8px;">Ø®Ø±ÙˆØ¬</button>`;
    
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        await client.auth.signOut();
        location.reload();
    });
    
    document.getElementById('upSection').style.display = 'block';
    document.body.classList.add('user-authenticated');
    
    document.getElementById('profileAvatar').textContent = firstLetter;
    document.getElementById('profileName').textContent = name;
    document.getElementById('profileEmail').textContent = user.email;
}

// Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function displayVideos(videos) {
    const div = document.getElementById('list');
    
    if (videos.length === 0) {
        div.innerHTML = `<div style='text-align: center; padding: 30px;'>
            ${allVideos.length > 0 ? 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.'}
            ${allVideos.length > 0 ? `<button class="btn" style="margin-top:15px;" onclick="document.getElementById('searchInput').value=''; filterLocally()">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</button>` : ''}
        </div>`;
        return;
    }

    let html = '';
    videos.forEach(v => {
        const viewCount = v.views || 0;
        const likeCount = v.likes || 0;
        const comments = allComments.get(v.id) || [];
        const commentCount = comments.length;
        const isLiked = userLikes.has(v.id);
        
        html += `
            <div class="video-item">
                <video 
                    src="${escapeHtml(v.url)}" 
                    controls 
                    data-id="${v.id}"
                    onplay="startViewTracking(${v.id}, this)"
                    onpause="endViewTracking(${v.id})"
                    onended="endViewTracking(${v.id})"
                ></video>
                <div class="p-15">
                    <b>${escapeHtml(v.title)}</b>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; color:#777; font-size:0.9rem;">
                        <span>Ø¨ÙˆØ§Ø³Ø·Ø©: ${escapeHtml(v.username || 'Ù…Ø³ØªØ®Ø¯Ù…')}</span>
                        <span>${new Date(v.created_at).toLocaleDateString('ar-EG')}</span>
                    </div>
                </div>
                <div class="video-stats">
                    <div class="stats-container">
                        <button class="stat-btn" title="Ù…Ø´Ø§Ù‡Ø¯Ø§Øª">
                            <span>ğŸ‘€</span> <span class="view-count-${v.id}">${formatNumber(viewCount)}</span>
                        </button>
                        <button class="stat-btn ${isLiked ? 'liked' : ''}" 
                                data-id="${v.id}" 
                                onclick="toggleLike(${v.id}, this)">
                            <span>â¤ï¸</span> <span class="like-count-${v.id}">${formatNumber(likeCount)}</span>
                        </button>
                        <button class="stat-btn" 
                                data-id="${v.id}" 
                                onclick="toggleComments(${v.id}, this)">
                            <span>ğŸ’¬</span> <span class="comment-count-${v.id}">${formatNumber(commentCount)}</span>
                        </button>
                    </div>
                    <div class="authenticated-only">
                        ${user?.user_metadata?.display_name === v.username ? `<button class="btn" style="background:#666; padding:3px 8px; font-size:0.8rem;" onclick="deleteVideo(${v.id})">Ø­Ø°Ù</button>` : ''}
                    </div>
                </div>
                <div id="comments-section-${v.id}" class="comments-section">
                    <div class="comment-input-container">
                        <textarea id="comment-input-${v.id}" class="comment-input" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§..." rows="2"></textarea>
                        <button class="comment-btn" onclick="addComment(${v.id})">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                    <div id="comments-list-${v.id}" class="comments-list">
                        ${commentCount > 0 ? '' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª'}
                    </div>
                </div>
            </div>
        `;
    });
    
    div.innerHTML = html;
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù„ÙƒÙ„ ÙÙŠØ¯ÙŠÙˆ
    videos.forEach(v => {
        const comments = allComments.get(v.id) || [];
        if (comments.length > 0) {
            renderComments(v.id, comments);
        }
    });
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
function filterLocally() {
    const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    
    if (!searchTerm) {
        displayVideos(allVideos);
        return;
    }
    
    const filteredVideos = allVideos.filter(video => 
        video.title.toLowerCase().includes(searchTerm) || 
        video.username.toLowerCase().includes(searchTerm)
    );
    
    displayVideos(filteredVideos);
}

// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØ¹Ù‚ÙŠØ¯Ø§Øª)
function showProfileSection() {
    document.getElementById('homeSection').style.display = 'none';
    document.getElementById('profileSection').style.display = 'block';
    currentView = 'profile';
    document.title = "Ù…Ù„ÙÙŠ - ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ±";
    displayUserVideos();
}

function showHome() {
    document.getElementById('profileSection').style.display = 'none';
    document.getElementById('homeSection').style.display = 'block';
    currentView = 'home';
    document.title = "ÙÙŠØ¯ÙŠÙˆ Ø´ÙŠØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©";
    displayVideos(allVideos);
}

function showProfile() {
    if (!user) {
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        openAuth();
        return;
    }
    showProfileSection();
}

function displayUserVideos() {
    const videosDiv = document.getElementById('userVideos');
    videosDiv.innerHTML = '<div style="text-align:center; padding:20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª... <div class="loading-spinner"></div></div>';
    
    try {
        if (!user) {
            videosDiv.innerHTML = "<div style='text-align: center; padding: 30px;'>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</div>";
            return;
        }
        
        const username = user.user_metadata?.display_name || "Ù…Ø³ØªØ®Ø¯Ù…";
        const userVideos = allVideos.filter(v => v.username === username);
        
        if (userVideos.length === 0) {
            videosDiv.innerHTML = "<div style='text-align: center; padding: 30px; color:#888;'>Ù„Ù… ØªÙ‚Ù… Ø¨Ø±ÙØ¹ Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¨Ø¹Ø¯</div>";
            return;
        }
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const totalVideos = userVideos.length;
        const totalViews = userVideos.reduce((sum, video) => sum + (video.views || 0), 0);
        const totalLikes = userVideos.reduce((sum, video) => sum + (video.likes || 0), 0);
        
        document.getElementById('videoCount').textContent = totalVideos;
        document.getElementById('totalViews').textContent = formatNumber(totalViews);
        document.getElementById('totalLikes').textContent = formatNumber(totalLikes);
        
        // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        let videosHTML = '';
        userVideos.forEach(v => {
            videosHTML += `
                <div class="video-item" style="margin-bottom:15px;">
                    <video src="${escapeHtml(v.url)}" controls style="width:100%; aspect-ratio:16/9; background:#000;"></video>
                    <div class="p-15">
                        <b>${escapeHtml(v.title)}</b>
                        <div style="display:flex; justify-content:space-between; margin-top:10px; color:#777; font-size:0.9rem;">
                            <span>ØªÙ… Ø§Ù„Ù†Ø´Ø±: ${new Date(v.created_at).toLocaleDateString('ar-EG')}</span>
                        </div>
                        <div class="video-stats">
                            <div class="stats-container">
                                <button class="stat-btn" title="Ù…Ø´Ø§Ù‡Ø¯Ø§Øª" disabled>
                                    <span>ğŸ‘€</span> <span>${formatNumber(v.views || 0)}</span>
                                </button>
                                <button class="stat-btn" title="Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª" disabled>
                                    <span>â¤ï¸</span> <span>${formatNumber(v.likes || 0)}</span>
                                </button>
                            </div>
                            <button class="btn" style="background:#666; padding:3px 8px; font-size:0.8rem;" onclick="deleteVideo(${v.id})">Ø­Ø°Ù</button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        videosDiv.innerHTML = videosHTML;
        
    } catch (e) {
        console.error('Error displaying user videos:', e);
        videosDiv.innerHTML = `<div class="error-message">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§ØªÙƒ: ${e.message}</div>`;
    }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙˆØ§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
function startViewTracking(videoId, videoElement) {
    if (!user) return;
    
    if (videoSessions.has(videoId)) {
        endViewTracking(videoId);
    }
    
    const sessionId = Date.now();
    videoSessions.set(videoId, {
        id: sessionId,
        startTime: Date.now(),
        element: videoElement,
        timeout: setTimeout(() => {
            if (videoSessions.get(videoId)?.id === sessionId) {
                incrementView(videoId);
                videoSessions.delete(videoId);
            }
        }, 3000)
    });
}

function endViewTracking(videoId) {
    const session = videoSessions.get(videoId);
    if (session) {
        clearTimeout(session.timeout);
        videoSessions.delete(videoId);
    }
}

async function incrementView(videoId) {
    try {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙˆØ±Ù‹Ø§
        const countElement = document.querySelector(`.view-count-${videoId}`);
        if (!countElement) return;
        
        const currentCount = parseInt(countElement.textContent.replace(/,/g, '')) || 0;
        countElement.textContent = formatNumber(currentCount + 1);
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        const video = allVideos.find(v => v.id === videoId);
        if (video) {
            video.views = currentCount + 1;
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†
            client.from('video_files')
                .update({ views: currentCount + 1 })
                .eq('id', videoId)
                .then(({ error }) => {
                    if (error) {
                        console.error('View update error:', error);
                        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                        countElement.textContent = formatNumber(currentCount);
                        video.views = currentCount;
                    }
                });
        }
    } catch (e) {
        console.error('Error incrementing view:', e);
    }
}

async function toggleLike(videoId, element) {
    if (!user) {
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¨Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª");
        openAuth();
        return;
    }
    
    const isLiked = element.classList.contains('liked');
    const countElement = element.querySelector(`.like-count-${videoId}`);
    if (!countElement) return;
    
    const currentCount = parseInt(countElement.textContent.replace(/,/g, '')) || 0;
    
    try {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ù‹Ø§
        if (isLiked) {
            element.classList.remove('liked');
            userLikes.delete(videoId);
            countElement.textContent = formatNumber(currentCount - 1);
        } else {
            element.classList.add('liked');
            userLikes.add(videoId);
            countElement.textContent = formatNumber(currentCount + 1);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        const video = allVideos.find(v => v.id === videoId);
        if (video) {
            if (isLiked) {
                video.likes = currentCount - 1;
                
                // Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
                client.from('video_likes')
                    .delete()
                    .match({ video_id: videoId, user_id: user.id })
                    .then(({ error }) => {
                        if (error) {
                            console.error('Like delete error:', error);
                            // Ø§Ù„ØªØ¹Ø§ÙÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                            element.classList.add('liked');
                            userLikes.add(videoId);
                            countElement.textContent = formatNumber(currentCount);
                            video.likes = currentCount;
                        }
                    });
            } else {
                video.likes = currentCount + 1;
                
                // Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¬Ø§Ø¨
                client.from('video_likes')
                    .insert([{ video_id: videoId, user_id: user.id }])
                    .then(({ error }) => {
                        if (error) {
                            console.error('Like insert error:', error);
                            // Ø§Ù„ØªØ¹Ø§ÙÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                            element.classList.remove('liked');
                            userLikes.delete(videoId);
                            countElement.textContent = formatNumber(currentCount);
                            video.likes = currentCount;
                        }
                    });
            }
        }
    } catch (e) {
        console.error('Error toggling like:', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨');
    }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
function toggleComments(videoId, element) {
    if (!user) {
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª");
        openAuth();
        return;
    }
    
    const commentsSection = document.getElementById(`comments-section-${videoId}`);
    const commentsList = document.getElementById(`comments-list-${videoId}`);
    const inputElement = document.getElementById(`comment-input-${videoId}`);
    
    if (activeComments.has(videoId)) {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        commentsSection.style.display = 'none';
        activeComments.delete(videoId);
        element.classList.remove('comments-active');
    } else {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        commentsSection.style.display = 'block';
        activeComments.add(videoId);
        element.classList.add('comments-active');
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­Ù…Ù„Ø©
        if (!allComments.has(videoId) || allComments.get(videoId).length === 0) {
            loadCommentsForVideo(videoId);
        }
        
        // ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
        setTimeout(() => {
            inputElement.focus();
        }, 100);
    }
}

async function loadCommentsForVideo(videoId) {
    const commentsList = document.getElementById(`comments-list-${videoId}`);
    commentsList.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª...';
    
    try {
        const {  comments, error } = await client
            .from('video_comments')
            .select('*')
            .eq('video_id', videoId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        if (!allComments.has(videoId)) {
            allComments.set(videoId, []);
        }
        allComments.set(videoId, comments || []);
        
        renderComments(videoId, comments || []);
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        const countElement = document.querySelector(`.comment-count-${videoId}`);
        if (countElement) {
            countElement.textContent = formatNumber(comments?.length || 0);
        }
    } catch (e) {
        console.error('Error loading comments:', e);
        commentsList.innerHTML = `<div class="comment-empty">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>`;
    }
}

function renderComments(videoId, comments) {
    const commentsList = document.getElementById(`comments-list-${videoId}`);
    if (!commentsList) return;
    
    if (comments.length === 0) {
        commentsList.innerHTML = `<div class="comment-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</div>`;
        return;
    }
    
    let html = '';
    comments.forEach(comment => {
        const timeAgo = getTimeAgo(new Date(comment.created_at));
        html += `
            <div class="comment-item">
                <div class="comment-header">
                    <span>${escapeHtml(comment.username)}</span>
                    <span class="comment-time">${timeAgo}</span>
                </div>
                <div class="comment-content">${escapeHtml(comment.content)}</div>
            </div>
        `;
    });
    
    commentsList.innerHTML = html;
}

async function addComment(videoId) {
    if (!user) {
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª");
        openAuth();
        return;
    }
    
    const inputElement = document.getElementById(`comment-input-${videoId}`);
    const commentText = inputElement.value.trim();
    
    if (!commentText) {
        alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚");
        return;
    }
    
    const btn = inputElement.nextElementSibling;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
    
    try {
        const username = user.user_metadata?.display_name || "Ù…Ø³ØªØ®Ø¯Ù…";
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙˆØ±Ù‹Ø§
        const newComment = {
            id: Date.now(),
            video_id: videoId,
            user_id: user.id,
            username: username,
            content: commentText,
            created_at: new Date().toISOString()
        };
        
        if (!allComments.has(videoId)) {
            allComments.set(videoId, []);
        }
        
        const comments = allComments.get(videoId);
        comments.unshift(newComment); // Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        allComments.set(videoId, comments);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ù‹Ø§
        renderComments(videoId, comments);
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        const countElement = document.querySelector(`.comment-count-${videoId}`);
        if (countElement) {
            countElement.textContent = formatNumber(comments.length);
        }
        
        // Ù…Ø³Ø­ Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
        inputElement.value = '';
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        client.from('video_comments')
            .insert([{
                video_id: videoId,
                user_id: user.id,
                username: username,
                content: commentText
            }])
            .then(({ error, data }) => {
                if (error) {
                    console.error('Comment insert error:', error);
                    // Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                    const updatedComments = allComments.get(videoId).filter(c => c.id !== newComment.id);
                    allComments.set(videoId, updatedComments);
                    renderComments(videoId, updatedComments);
                    countElement.textContent = formatNumber(updatedComments.length);
                    alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŒ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶');
                } else if (data && data.length > 0) {
                    // ØªØ­Ø¯ÙŠØ« ID Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ÙØ¹Ù„ÙŠ
                    const localIndex = allComments.get(videoId).findIndex(c => c.id === newComment.id);
                    if (localIndex !== -1) {
                        const updatedComments = [...allComments.get(videoId)];
                        updatedComments[localIndex].id = data[0].id;
                        allComments.set(videoId, updatedComments);
                    }
                }
            });
        
    } catch (e) {
        console.error('Error adding comment:', e);
        alert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: ' + (e.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diff = now - date;
    
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) {
        return `${days} ÙŠÙˆÙ…${days > 1 ? 'ÙŠÙ†' : ''} Ù…Ø¶Ù‰`;
    } else if (hours > 0) {
        return `${hours} Ø³Ø§Ø¹Ø©${hours > 1 ? 'ØªØ§Ù†' : ' ÙˆØ§Ø­Ø¯Ø©'} Ù…Ø¶Øª`;
    } else if (minutes > 0) {
        return `${minutes} Ø¯Ù‚ÙŠÙ‚Ø©${minutes > 1 ? 'ØªÙŠÙ†' : ' ÙˆØ§Ø­Ø¯Ø©'} Ù…Ø¶Øª`;
    } else {
        return `${seconds} Ø«Ø§Ù†ÙŠØ© Ù…Ø¶Øª`;
    }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø­Ø°Ù
document.getElementById('upBtn').addEventListener('click', doUpload);
async function doUpload() {
    const t = document.getElementById('vTitle').value.trim();
    const fileInput = document.getElementById('vFile');
    const f = fileInput.files[0];
    const btn = document.getElementById('upBtn');
    
    if (!t || !f) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ");
    if (!user) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");

    btn.disabled = true;
    btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... <div class='loading-spinner' style='display:inline-block; width:16px; height:16px; margin-left:10px;'></div>";

    try {
        // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
        const path = `${Date.now()}_${sanitizeFilename(f.name)}`;
        const { error: uploadError } = await client.storage
            .from('videos')
            .upload(path, f, { upsert: true });
        
        if (uploadError) throw uploadError;

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù…
        const {  publicData, error: urlError } = await client.storage
            .from('videos')
            .getPublicUrl(path);
        
        const publicUrl = publicData?.publicUrl;
        
        if (urlError || !publicUrl) {
            throw new Error('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¹Ø§Ù…');
        }

        const username = user.user_metadata?.display_name || `user_${Date.now().toString(36).slice(2, 8)}`;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const {  newVideo, error: dbError } = await client.from('video_files').insert([{
            title: t,
            url: publicUrl,
            path: path,
            username: username,
            views: 0,
            likes: 0,
            created_at: new Date().toISOString()
        }]).select().single();
        
        if (dbError) throw dbError;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ù‹Ø§
        allVideos.unshift(newVideo);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if (currentView === 'home') {
            displayVideos(allVideos);
        } else {
            displayUserVideos();
        }

        btn.disabled = false;
        btn.innerHTML = "Ø±ÙØ¹ Ø§Ù„Ø¢Ù†";
        document.getElementById('vTitle').value = "";
        fileInput.value = "";
        
        alert("ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!");

    } catch (e) {
        console.error('Upload error', e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: " + (e.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        btn.disabled = false;
        btn.innerHTML = "Ø±ÙØ¹ Ø§Ù„Ø¢Ù†";
    }
}

async function deleteVideo(videoId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ')) return;
    
    try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        const video = allVideos.find(v => v.id === videoId);
        if (!video) throw new Error('Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        
        // Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { error: dbError } = await client
            .from('video_files')
            .delete()
            .eq('id', videoId);
        
        if (dbError) throw dbError;
        
        // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
        if (video.path) {
            try {
                await client.storage
                    .from('videos')
                    .remove([video.path]);
            } catch (storageError) {
                console.warn('Storage delete warning:', storageError);
            }
        }
        
        // Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        await Promise.all([
            client.from('video_likes').delete().eq('video_id', videoId),
            client.from('video_comments').delete().eq('video_id', videoId)
        ]);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        allVideos = allVideos.filter(v => v.id !== videoId);
        allComments.delete(videoId);
        userLikes.delete(videoId);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if (currentView === 'home') {
            displayVideos(allVideos);
        } else if (currentView === 'profile') {
            displayUserVideos();
        }
        
        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!');
    } catch (e) {
        console.error('Error deleting video', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ' + e.message);
    }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
function openAuth() { 
    document.getElementById('aModal').style.display = 'flex';
    document.getElementById('authError').textContent = '';
}

function toggleA() {
    isSign = !isSign;
    document.getElementById('aTitle').innerText = isSign ? "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" : "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„";
    const userInput = document.getElementById('aUser');
    userInput.style.display = isSign ? "block" : "none";
    userInput.value = "";
    document.getElementById('authError').textContent = '';
}

document.getElementById('aConfirmBtn').addEventListener('click', auth);
async function auth() {
    const e = document.getElementById('aEmail').value.trim();
    const p = document.getElementById('aPass').value;
    const u = document.getElementById('aUser').value.trim();
    const errorEl = document.getElementById('authError');

    if (!e || !p) {
        errorEl.textContent = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
        return;
    }
    if (isSign && !u) {
        errorEl.textContent = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        return;
    }

    try {
        const btn = document.getElementById('aConfirmBtn');
        btn.disabled = true;
        btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©... <div class='loading-spinner' style='display:inline-block; width:16px; height:16px; margin-left:10px;'></div>";
        errorEl.textContent = '';

        if (isSign) {
            const { error } = await client.auth.signUp({ 
                email: e, 
                password: p, 
                options: { 
                     { 
                        display_name: u || `user_${Date.now().toString(36).slice(2, 8)}` 
                    } 
                } 
            });
            if (error) throw error;
        } else {
            const { error } = await client.auth.signInWithPassword({ email: e, password: p });
            if (error) throw error;
        }
        
        document.getElementById('aModal').style.display = 'none';
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await loadUserSession();
        setupUserInterface();
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©
        if (currentView === 'home') {
            await loadAllVideos();
            await loadAllComments();
            displayVideos(allVideos);
        } else {
            displayUserVideos();
        }
        
    } catch (err) {
        console.error('Auth error', err);
        const msg = err?.error?.message || err?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©';
        errorEl.textContent = msg;
    } finally {
        const btn = document.getElementById('aConfirmBtn');
        btn.disabled = false;
        btn.innerHTML = "ØªØ£ÙƒÙŠØ¯";
    }
}

document.getElementById('aModal').addEventListener('click', (e) => {
    if (e.target.id === 'aModal') {
        document.getElementById('aModal').style.display = 'none';
    }
});

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function sanitizeFilename(name) {
    return name.replace(/[^a-zA-Z0-9.\-_Ø¡-ÙŠ ]/g, '_').replace(/\s+/g, '_');
}

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
async function createTestData() {
    try {
        const testVideos = [
            {
                title: "Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©",
                url: "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4",
                username: "Ù…Ø·ÙˆØ± ÙˆÙŠØ¨",
                views: 156,
                likes: 24,
                path: "intro_programming.mp4"
            },
            {
                title: "ØªØµÙ…ÙŠÙ… ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
                url: "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4",
                username: "Ù…ØµÙ…Ù… UI",
                views: 89,
                likes: 17,
                path: "ui_design.mp4"
            },
            {
                title: "Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
                url: "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4",
                username: "Ù…Ù‡Ù†Ø¯Ø³ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
                views: 213,
                likes: 31,
                path: "database.mp4"
            }
        ];
        
        // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        await client.from('video_files').delete();
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        for (const video of testVideos) {
            await client.from('video_files').insert([{
                title: video.title,
                url: video.url,
                username: video.username,
                views: video.views,
                likes: video.likes,
                path: video.path,
                created_at: new Date().toISOString()
            }]);
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await loadAllVideos();
        displayVideos(allVideos);
        
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (e) {
        console.error('Error creating test data:', e);
        alert("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©: " + e.message);
    }
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', () => {
    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„
    if (!user) {
        document.getElementById('nav').innerHTML = `
            <button class="btn" onclick="initializeApp()" style="background:#2196F3; margin-right:8px;">Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="btn" onclick="openAuth()">Ø¯Ø®ÙˆÙ„</button>`;
    }
});
</script>
</body>
</html>
